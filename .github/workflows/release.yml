name: Release to Google Play

on:
  # Manual trigger with confirmation
  workflow_dispatch:
    inputs:
      confirm_release:
        description: 'Type "RELEASE" to confirm deployment to Google Play'
        required: true
        type: string
      track:
        description: 'Deployment track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
  
  # Automatic trigger on release tags (builds AAB but requires approval to deploy)
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Only match semantic versioning like v1.0.2

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  JAVA_VERSION: '17'

jobs:
  # ===========================================
  # Job 1: Validate Changelog Strings
  # ===========================================
  validate-changelog:
    name: Validate Changelog
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version_code: ${{ steps.version.outputs.code }}
      version_name: ${{ steps.version.outputs.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "name=$TAG" >> $GITHUB_OUTPUT
          # Convert 1.0.2 to 1_0_2 for string resource name
          SANITIZED=$(echo $TAG | tr '.' '_')
          echo "code=$SANITIZED" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $TAG (string key: whats_new_v$SANITIZED)"

      - name: Check changelog string exists
        run: |
          VERSION_CODE=${{ steps.version.outputs.code }}
          STRING_KEY="whats_new_v${VERSION_CODE}"
          
          echo "üîç Looking for string: $STRING_KEY"
          
          if grep -q "name=\"$STRING_KEY\"" app/src/main/res/values/strings.xml; then
            echo "‚úÖ Found $STRING_KEY in strings.xml"
          else
            echo "‚ùå ERROR: Missing $STRING_KEY in strings.xml"
            echo ""
            echo "Please add the following to app/src/main/res/values/strings.xml:"
            echo "  <string name=\"$STRING_KEY\">‚Ä¢ Your changelog here</string>"
            echo ""
            echo "And update getChangelogForVersion() in WhatsNewDialog.kt"
            exit 1
          fi

      - name: Verify string in all locales
        run: |
          VERSION_CODE=${{ steps.version.outputs.code }}
          STRING_KEY="whats_new_v${VERSION_CODE}"
          MISSING=""
          
          for locale_dir in app/src/main/res/values-*/; do
            locale=$(basename $locale_dir)
            if [ -f "$locale_dir/strings.xml" ]; then
              if ! grep -q "name=\"$STRING_KEY\"" "$locale_dir/strings.xml"; then
                MISSING="$MISSING $locale"
              fi
            fi
          done
          
          if [ -n "$MISSING" ]; then
            echo "‚ö†Ô∏è WARNING: $STRING_KEY missing in:$MISSING"
            echo "Consider adding translations for these locales."
          else
            echo "‚úÖ All locales have $STRING_KEY"
          fi

  # ===========================================
  # Job 2: Build Signed AAB
  # ===========================================
  build-release:
    name: Build Release AAB
    needs: validate-changelog
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/upload.keystore

      - name: Create keystore.properties
        run: |
          cat > keystore.properties << EOF
          storeFile=upload.keystore
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

      - name: Build Release AAB
        run: ./gradlew --build-cache --configuration-cache bundleRelease

      - name: Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Upload Mapping File
        uses: actions/upload-artifact@v4
        with:
          name: mapping
          path: app/build/outputs/mapping/release/mapping.txt
          retention-days: 90

  # ===========================================
  # Job 3: Deploy to Google Play
  # ===========================================
  deploy-google-play:
    name: Deploy to Google Play
    needs: [validate-changelog, build-release]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Requires GitHub Environment approval (set up in repo settings)
    environment: production
    # Only run if:
    # 1. Manual dispatch with "RELEASE" confirmation, OR
    # 2. Tag push (requires environment approval in GitHub)
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_release == 'RELEASE') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Verify release confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm_release }}" != "RELEASE" ]; then
            echo "‚ùå Release not confirmed. You must type 'RELEASE' to deploy."
            exit 1
          fi
          echo "‚úÖ Release confirmed for ${{ github.event.inputs.track }} track"

      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download AAB Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-aab
          path: ./aab

      - name: Download Mapping File
        uses: actions/download-artifact@v4
        with:
          name: mapping
          path: ./mapping

      - name: Extract Release Notes from CHANGELOG
        id: changelog
        run: |
          VERSION=${{ needs.validate-changelog.outputs.version_name }}
          
          # Extract English release notes between <en-US> tags for this version
          NOTES=$(awk "/## v$VERSION/,/## v[0-9]/" CHANGELOG.md | \
                  awk '/<en-US>/,/<\/en-US>/' | \
                  sed '/<en-US>/d; /<\/en-US>/d' | \
                  head -c 500)
          
          if [ -z "$NOTES" ]; then
            NOTES="Bug fixes and performance improvements."
          fi
          
          # Escape for GitHub Actions
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "üìù Release notes:"
          echo "$NOTES"

      - name: Determine deployment track
        id: track
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "track=${{ github.event.inputs.track }}" >> $GITHUB_OUTPUT
          else
            echo "track=internal" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.davy
          releaseFiles: ./aab/*.aab
          track: ${{ steps.track.outputs.track }}
          status: draft
          mappingFile: ./mapping/mapping.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: DAVy v${{ needs.validate-changelog.outputs.version_name }}
          body: |
            ## What's New
            ${{ steps.changelog.outputs.notes }}
            
            ---
            üì¶ **Download:** Available on Google Play (internal track)
            üîó **Full Changelog:** See CHANGELOG.md
          draft: true
          prerelease: false
          files: |
            ./aab/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================
  # Job 4: Notify on Failure
  # ===========================================
  notify-failure:
    name: Notify on Failure
    needs: [validate-changelog, build-release, deploy-google-play]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Report Failure
        run: |
          echo "‚ùå Release workflow failed!"
          echo "Check the Actions tab for details."
